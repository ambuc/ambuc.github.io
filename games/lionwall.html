<!--
    TODO(ambuc): Reveal solutions
-->
<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <!-- lodash -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"
        integrity="sha256-qXBd/EfAdjOA2FGrGAG+b3YBn2tn5A6bhz+LSgYD96k=" crossorigin="anonymous"></script>

    <!-- animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- noto cjk sc -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <!-- must set rel="preload", or you get flashing -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100&display=swap" rel="stylesheet">

    <style>
        #gameboard .cell {
            font-size: 4em;
            font-family: 'Noto Sans SC', sans-serif;
            font-weight: 100;
        }
    </style>

    <title>Lion Wall</title>
</head>

<body class="container-fluid bg-dark">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
    <div class="container-fluid py-5">
        <div class="row">
            <h1 class="text-muted text-center">
                <span>Lion Wall</span>
                <br />
                <a class="btn btn-dark btn-sm text-muted" data-bs-toggle="collapse" href="#instructions">
                    Instructions
                </a>
            </h1>
            <div class="collapse" id="instructions">
                <div class="card text-white bg-dark border-secondary mb-5"
                    style="max-width: 30rem; margin-left: auto; margin-right: auto;">
                    <div class="card-body">
                        <p> This game is the "Connecting Wall" from <a
                                href="https://en.wikipedia.org/wiki/Only_Connect">Only
                                Connect</a>, a British television quiz show.</p>
                        <p>The wall consists of sixteen clues, consisting of four groups of four connected items. The
                            implementation below uses Chinese characters with common subcomponents. The wall includes
                            red
                            herrings and more connections than actually exist, such that some cards appear to fit into
                            more
                            than
                            one category.</p>
                        <p>You can click or tap a card to select it. If you're at a keyboard, you may find it faster to
                            use
                            the
                            keys, like so:
                        <div class="row">
                            <div class="col-12 col-sm-8 offset-sm-4 col-md-6 offset-md-3">
                                <table class="table table-dark text-light table-sm">
                                    <tbody>
                                        <tr>
                                            <td>1</td>
                                            <td>2</td>
                                            <td>3</td>
                                            <td>4</td>
                                        </tr>
                                        <tr>
                                            <td>q</td>
                                            <td>w</td>
                                            <td>e</td>
                                            <td>r</td>
                                        </tr>
                                        <tr>
                                            <td>a</td>
                                            <td>s</td>
                                            <td>d</td>
                                            <td>f</td>
                                        </tr>
                                        <tr>
                                            <td>z</td>
                                            <td>x</td>
                                            <td>c</td>
                                            <td>v</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        </p>
                        <p>If you have selected four cards which form a valid group, they will fade out and reappear at
                            the top of the board as a highlighted, solved group.</p>
                        <p>Once you have found all four groups, reload the page for a new game.</p>
                    </div>
                    <div class="card-footer bg-transparent border-secondary">
                        <a href="#instructions" class="btn btn-dark btn-sm text-white"
                            data-bs-toggle="collapse">Close</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="gameboard" style="max-width: 500px; margin-left: auto; margin-right: auto;">
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-3 text-center"> <span class="cell badge animate__animated p-2 my-2"> 0 </span>
            </div>
            <div class="col-12 text-center visually-hidden" id="reloadRow">
                <a href="" class="btn btn-dark btn-lg my-2 text-light" style="font-size:3em;"> ⟳ </a>
            </div>
        </div>
    </div>

    <script>
        var semaphore = 0

        function ensureSemaphoreZero() {
            return new Promise(function (resolve, reject) {
                (function waitForSemaphoreZero() {
                    if (semaphore == 0) return resolve();
                    setTimeout(waitForSemaphoreZero, 10);
                })();
            });
        }

        const sleep = (milliseconds) => {
            semaphore++
            return new Promise(resolve => {
                setTimeout(resolve, milliseconds)
            }).then(() => {
                semaphore--
            })
        }

        const isSelectedClass = "bg-light"
        const defaultButtonClass = "defaultClass"
        const possiblePuzzles = ["媆奸娃娅旱晆晋曔悊恚恶憼蜇蝡虷蟼",
          "亿朰忆乪杕忕畚芖咯恪畧茖唎俐梸莉",
          "仉釠鳧机錋鵬棚掤溢鷁榏搤涱倀鋹掁",
          "仳僮仙休勭屴朸艻稚崔椎萑秏毞氃芼",
          "佟柊鉖昸梚鋔晚絻訏釪旴紆詻佫格絡",
          "侰桾莙涒株茱洙誅怏英泱詇憍僑橋譑",
          "偢媝萩楸姿茨栥粢沫茉枺粖湎偭媔糆",
          "僯橉潾膦檀澶膻嬗軼泆胅妷輀侕栭耍",
          "儉澰譣鐱灋詓鉣胠呟詃鉉胘亴仇氿肍",
          "加氻边肋沖迚肿仲雥進脽倠犨吿汼件",
          "劤斬析斫俥休佦侎迄杚矻籺辿屴輋籼",
          "厪圧厞厗芏菲莘著尾屝屖屠覒覲垷覩",
          "叔叙权难狳狇猚獢炶炑焳燆敁敊敍敽",
          "吃屹杚釳屳杁釞込括栝銛适捙唓輋連",
          "吗哇喃唟罣罱罢署諯諵詓諸篅笃筀箸",
          "吭坑鈧沆堿鍼減碱刦鉣法砝剦唵埯硽",
          "呣砪栂拇确桷捔鵤佴栮挕鵈伢呀砑鴉",
          "呾鉭查担鉮柛捜伸汿杼抒伃瀧嚨鑨儱",
          "咄朏础柮膰磻橎蕃壘礨櫐藟堄唲腉萖",
          "咪嘽唻嘵鄲郲隢陘頥顂顤頸弫粥彈弳",
          "咾姥銠恅娪鋙悟梧攲鈘忮枝骑吗妈杩",
          "唒鯂梄酒鰉楻湟偟鉰柌泀伺鐃嘵鱙僥",
          "唬錿鯱椃釞魞杁扖純魨杶扽紐吜鈕扭",
          "嗎榪鷌媽椏鵶婭掗磏鶼嫌搛硦哢梇挵",
          "嘍瘻僂漊症佂泟鉦鵒俗浴鋊鴙知疾鉃",
          "噌潧增憎湢堛愊偪蕢墤憒僓莪哦涐俄",
          "圖园囫圄岏岉峿岢犓物牾牱鄒鄙邧阿",
          "坰泂炯詗泟炡証鉦鄗熇謞鎬郫埤渒錍",
          "坽炩拎詅焌捘誜浚軫抮診沴轁塪熖滔",
          "坽蛉柃舲螠榏艗嗌鵭樢鵃鷰錏堊蝁啞",
          "垟堤埞圿碮碇砎碻絊綻紒縞翉翔翨翯",
          "垻賿賡屓鹨鹒鸤茑鶏鶊鳲蔦颫堸飂葻",
          "壔坫圻壀迠近避進鍺釿鐴錐煮燾点燞",
          "奅戻釱圶肩鈅肚楕覱鋧垷梘暫昴昈杲",
          "奞售崔碓軎輋硨軞竏岦砬竓粁类咪粍",
          "奞奜夼奝騑馴騆騟紪紃綢緰疵痽痱瘉",
          "妑岜巼蚆嵝喽蝼蒌銠咾蛯荖鐱嬐嶮薟",
          "妿迦泇架逝浙梊埑郛浮桴垺阱妌进坓",
          "姆拇鉧胟抮鉁胗診輕鋞脛誙輬婛掠諒",
          "姐鉏阻苴鉳邶苝背榆隃萮腧枦妒鈩肩",
          "娌埋荲捚坵茊拞邱鮭茥挂邽鮈姁坸邭",
          "娢鋡唅誝鉮呻訷伸陫啡誹俳鄝嫪鏐僇",
          "孲孹斈孡嬖妏始娅愈忞怠恶瘉瘂癖痖",
          "寭宁宇寥酊酑醪醝髆骬髎髊縛繐糽縒",
          "屴另朸釛哨梢銷俏遄椯鍴偳遇嵎喁偶",
          "屸江虹杠渫蝶楪揲魭蚖杬抏鱗嶙潾撛",
          "岔杣岻峈榾骶骼磆褄袛袼袥霋雰雬雼",
          "崚棱倰睖枤伏狊汱纹伩盿汶缜嵮槙滇",
          "崳逾毹媮迦毠妿枷宕宒安宋硝峭逍梢",
          "巏驩孉灌駪姺洗烍胢妸河炣胶峧駮烄",
          "巿鿖灭亍佮倐仃佊痘疢疔疲頭幁頜頗",
          "帖帩帷帗捎推拔操膲脽胈臊趭趈趙趮",
          "帷猚倠售獁傌嗎榪閈們問椚皯帔狓柀",
          "床庄庉麻灶炖焚烺澶沌淋浪羶样垟羪",
          "庘魻岬柙鱎嶠橋蟜觎岘枧蚬羭庠鮮蛘",
          "庢床庋廉槐鬾魐媿峮岐嵰巕宭室宋安",
          "廥矿廖庤鿬疁畤畽跑蹘跱踵袍襘袥褈",
          "彼徇徤徧駨騝騗驂牯犍犏犙怙怶恂慘",
          "徥湜隄鍉汧邢鈃鳽搤隘鎰鷁撇徶潎鷩",
          "忒吢悆悲嗎駼騑駱独狳猅狢蜼隿售雒",
          "怩伲柅抳仳枇批芘焛椚捫菛熮憀僇蓼",
          "恲併絣栟倏紎枤吠鳨鷥樢鷰劫怯佉唟",
          "悟焐俉晤焍俤晜綈封付时紂鞋愅煂緙",
          "慪嘔蓲樞吺芟榖伇泡苞枹佨汻忤吘仵",
          "扐撽抄担儌仯但佦觻觘觛确皪劰皦砶",
          "扲擉抱抳躅跑跜踷痥疱痆瘏裞衿襡褚",
          "抌沈忱訦淋惏諃婪勯憻譠嬗勏掊涪婄",
          "抓枛沠釽檘澼鐴鸊昉汸鈁鴋晜挮梯鵜",
          "抯砠鉏沮硾錘涶棰詚鉭泹柦訨扯砋杫",
          "抴揲揋掜鲽鳂鲵鲱狜猥猊猅居屜屧屝",
          "拘泃蚼坸汦蚔坁芪魵蚠坌芬魶抐汭芮",
          "掾湪蒃蝝湟葟蝗惶紙芪蚔忯縜損溳愪",
          "昑枔汵鈐椊淬錊萃妒沪鈩芦妘昙枟芸",
          "昛姖钜苣嫚镘蔓謾侗铜茼詷侲晨娠誫",
          "昭蛁鮉紹蛔鮰絗洄鉈鮀紽沱鋡晗蛿浛",
          "暌昭昳曉袑袟襓衱槷柣橈极驇騤駋馺",
          "朸鳨氻劯鶹溜磂媹掕淩碐婈护枦鳸妒",
          "杫扯蘷肯挽莬脕輓阂荄胲輆闰枉抂軖",
          "杸吺没竐古汁辛籵娪汝妾娄敔枚呚敉",
          "极砐圾汲矺圫汑仛蟺壇澶儃蚬枧砚伣",
          "枓阧蚪鈄郆蛣銡佶諌蝀錬倲訽枸邭佝",
          "柄抦炳苪扗灻芏汢詗炯苘泂訫杺抋沁",
          "柢岻鴟茋崍鶆萊鯠頵鵘莙鮶湏梁汕漁",
          "柲鉍妼駜銑姺駪洗芦妒馿沪茧蚞鉵浊",
          "栓佺烇洤倥焢涳控峛烮洌挒峮桾侰捃",
          "桱氫涇莖氟沸茀胇賬涱萇脹賅核氦胲",
          "梧峿娪焐嵇姀秌穌吤妎炌魪呫枮岾鮎",
          "梯挮綈銻扎糺釓軋羥經鋞輕庠床扩庫",
          "椁鶉諄淳鴜訿泚佌钲証泟佂铫桃鴵佻",
          "椃唬萀諕嘽蕇譂蟬煠葉諜蝶炓枓呌蚪",
          "椑稗捭焷稊挮焍娣汞扛灴妅囦困囷囡",
          "楕膏塍朎咩垟羚羺薜芏苓薷孹李享孺",
          "檘噼薜澼呠苯泍体怊苕沼佋悝梩哩俚",
          "歧杫阯沚柰际沶眎窛邧沅盶釹鈘鈢鉬",
          "毲蚝毼毴独猲猅獛襨褐裶襆轛輟蛼轐",
          "毼毠毱毟妿婅妙妾粰粷粆粒桴楬架亲",
          "汔釳扢杚鍠揘楻騜炉护枦馿烍洗銑駪",
          "泌佖鉍鮅儒鑐鱬繻鿴鉖鮗終鱿沋优紌",
          "洋样鴹羝榾鶻骶骱邝隝阺阶廆溾槐魀",
          "浘荱娓梶茇妭柭軷猶媨楢輶独浊茧蛼",
          "浙娎梊哲姷栯哊侑詁枯咕估誽淣婗倪",
          "湢葍逼鶝茢迾鴷栵咖迦鴐枷哂洒茜栖",
          "湦鍟腥謃鐙膯證噔旭肍訅亴昢泏鈯咄",
          "炻鮖佦鉐鮸俛鋔絻晫倬鋽綽晹焬鯣緆",
          "焇熛烓烊鳔鲑鲜鲵觖觟觧觬訣誚謤誽",
          "熰驅嶇蓲鷌嶌蔦鿂捃峮莙輑拄炷駐軴",
          "牌沜魸扸江魟扛釭莬鮸挽鋔虄蜱浊鉵",
          "牴牡牱犃坧砢碚碱璮珂琣瑊羶羝垟羬",
          "狽貼賢閴蛅蜸閩浊砬竪閚泣碸猦颭渢",
          "獚狇狡獥樂皎皦岶窐窔竅岤觟觵桷崅",
          "璣琑琣璔焇焙熷燐洼涪潧潾硅磯硝磷",
          "瓨瓫甑瓧汾潧汁汌誷譄計訓網紅紛紃",
          "瘋堸颯颺圼音暘蚎淗泣湯浊龾疲坡蚾",
          "療鐐橑憭鏢標慓僄许杵忤仵诲痗鋂侮",
          "皰泡鉋佨泎鈼作昨靕鉦佂昰鲭鲏渔鲁",
          "盱衧汙邘裬淩陵菱傊溳鄖蒷仠盰衦芉",
          "眭睼眵瞕遈迻遧逕瘕痑瘴痙徦徍徥徑",
          "睍垷俔鋧堋倗錋棚噔僜鐙橙哆眵垑栘",
          "睖瞘相眰驅榪駤驓居杘屋層估倰傴僧",
          "瞺薈儈繪蒫傞縒嗟悓俔絸哯恀眵茤哆",
          "砓芟投役萹揙徧褊鳖撇徶襒鲮碐菱裬",
          "砙瓵瓲旊鲐鲀鲂鳃钬钝钫锶煈碸颱颸",
          "碓誰唯婎訮咞妍蚈苒呥姌蚺葛碣謁蝎",
          "磵磣柘宕毿枆宒覒孢李字覎苞蕳蔘萈",
          "礶礀硑柘鷳鵧樢鴣屑屏杘居娋孉嫺姑",
          "禆社祄祏里畍鿬細骭骱磆縎靬鞞靯緙",
          "秼秓秆稞頍頇顆顃餁飦餜餤袵袾衼裧",
          "穴仈汃朳佌泚柴茈焙涪棓菩熮寥僇蓼",
          "穿窝窧窡娲婥娺婪罝罩罬罧苴芽莴菻",
          "窠窒岤空洷溄江沚食仚仝企踉踝跮趾",
          "窭空窄岤讧诈讪证炅昨旵昰炇数攻政",
          "笯簞篬筒戰戧戙聀咪嗆哃咠粥弩彈弭",
          "篻篁答箶餭餄餬餡鹓鸽鹕鹐埦墂堭埳",
          "籼粹粙粜捽抽拙扛筄笛笜笁窕岤窣空",
          "粅粶咪粗趢唗趄超鑡嚙齟齠釗刎剥刟",
          "粘枮阽詀棑陫誹悱絰郅誈恎綪精棈情",
          "糇糃籺銤碭矻鉐砲齟齕鑡齙飷餱餳飽",
          "紿綳縑絈硼磏砶硝嵬魐魄魈軕軩輣輎",
          "絤茜洒晒鿓湏暊頟螞浊蚎蛒駤絰荎臵",
          "綨緆絈綈锡铂锑错这迫递逪刘剘剔剒",
          "緘嵅鍼顑籼銤纇粫形釤頿耏鳽鷥嶌鴯",
          "罘罾署罷熷煑熋煶蠕蝫螚蝭儒伓僧偍",
          "羍佯羳羥伙燔烴烙蹊蹯踁路雞奞倠雒",
          "羷險顩薟郡頵莙覠烾顃菼覢社祥祁視",
          "羿鮙挧蛡鰾摽螵嘌伩抆蚉吝佉弆魼唟",
          "股殾砓竐堵坧垃圾雱雼雴雭钫钥锗钑",
          "肥胅胀脹帙帐帳帩彁张張弰鿔钯铁销",
          "膧潼噇橦酒唒梄莤紦吧杷芭絡胳洛茖",
          "芖釱杕夻鉝亲咅位孲李吇仔閸菛鍆們",
          "芟伇般杸伙烐炑灿鳴鵃樢嶌咉英佒岟",
          "芭把疤肥掁痮脹鋹畛疹胗鉁畉芙扶鈇",
          "芺呑沃穾名汐穸釸宨洮窕銚宸莀唇鋠",
          "芺袄鴁扷裼鶍掦睗秪鴟抵眡秣茉袜眜",
          "苒姌柟袡耍栭袻侕抯査袓伹挒茢姴例",
          "苞枹咆佨样善佯詳崜唾倕諈嵐葻楓諷",
          "茁泏咄鈯沂听釿忻粮哴鋃悢氣芞汽忾",
          "茆葴芵菁减决凊冼詅訣請詵玲珋瑊珗",
          "茢挒咧姴撩嘹嫽鐐枎呋妋鈇棓菩掊錇",
          "莢浹挾蛺汋扚虳杓縸摸蟆模絤茜洒栖",
          "莨桹娘誏柇姀訸鉌鶇娻諌錬鳶芅杙釴",
          "萃椊睟祽椆睭禂鵰碌睩禄鵦乭艺朰鳦",
          "蔈莦著薛屑屠屖杘确觰觪桷碸飄颵楓",
          "虸杍仔汓柀佊波頗碹佦沰碩煊烛炑煩",
          "蚊蜫蛌繭窤窊茓穻彃弧芎弙滭汶混汙",
          "蜝螗蝶蚱煻煠炸烳譕諜詐誧鷡鶀鶶鵏",
          "蜡螵蝫蛅瘭瘏痁疱爢煮点炰劘剒剽刨",
          "蝁俹椏掗伯柏拍鮊託杔托魠詔蛁佋鮉",
          "螯浊閩蜍淮閵雓魋梬閑梌槐聘聱洱聭",
          "蠐儕懠薺倓惔菼棪呫怗苫梷啘蜿倇椀",
          "袑衧袥袼骬磆骼榾寰宕客宋彋弨弙杛",
          "襎蕃嬏鱕莬娩鮸俛煌媓鰉偟炜袆苇伟",
          "覒軞竓氊鿂鴗鸇鴝拓拉擅拘岩峴軕岣",
          "觝触觚埆浊泒汢江屄攨竈空屓貾蛽貢",
          "訃釙补虲鉈袉蛇柁汨衵蚎杲浛誝鋡梒",
          "訏釪芋杅鈃茾枅妍猁莉梨娳猓課錁婐",
          "記记邔屺讶邪岈蚜杌阢屼虺椆調调蜩",
          "訰忳盹旾惔睒晱婒巒矕曫孌岞詐怍妰",
          "訶訪誺証矈睞眐睢鳱鶆鴊鵻閈閜閍閵",
          "訷妽呻神娠唇祳侲鈷咕祜估鉦証姃佂",
          "詯誗讓話鬁鬤髺髶饎饟餂餌憙息悡恥",
          "詳訂誠訲钉铖钟铺昷盛盅盙旷庠庁庯",
          "誀聎聠耵庣庰庁店芇帡帄帖莧誢覜覘",
          "誜捘荾睃抹茉眜妺艄莦睄娋舡訌扛妅",
          "調蜩椆郮蚢杭邟鈧怲柄陃鈵悓誢蜆鋧",
          "諱談誜諥痰痠瘇瘍毘畯畽畼吡喡啖啺",
          "讲诮诃访艄舸舫艂钤钶钫锋汵汫消浲",
          "赥欨欣欹齣齗齮嚙捔折掎扣触赨蚼虽",
          "趈趍趇唗鉹鉝鉛鍺砓竐嗀殾袥袩袳褚",
          "趺踁跆踈殌殆殐肂鿑冶凁冿砡砆硜硉",
          "趻蹺踖蹎橈棤槙朾厜厝厧厅諈訡譊訂",
          "跆踃踁蹕弰弳彃杛焛烴熚炑闏颱颵楓",
          "蹁蹸跬跮瞵眭眰盹窑窐窒窀缻甂甐瓲",
          "迪柚伷油櫳儱瀧攏鰾僄漂摽鮡逃桃挑",
          "這遤迸迢媽姘妱媰鷥絣紹縐鵻讎騅雛",
          "邩邚邷鄥妉瓭鴆鈂壀甓鷿鐴坺炦妭鈸",
          "酄灌權懽渄棑悱腓啌椌悾腔吂邙汒肓",
          "酻醀醦酝稚穇秐穗栒槮枟橞珣琈琟璤",
          "醉梄酐酚枚攼攽敳碮矸砏磑崼崪杣嵦",
          "釠鈾鋑顉岫峻崸杣貱皴頗柀屓凥届杘",
          "釫杇圬芌櫐壘藟蠝娐垺莩蜉妐鈆枩蚣",
          "鈱呡泯姄咥洷姪峌迪油妯岫逧鋊唂峪",
          "鈼泎作苲浱侲莀桭蝎偈葛楬蚷鉅洰柜",
          "鉺鈢鵭釷枋鴋堃防浿鵙垻郥沚耻杫阯",
          "銷娋焇痟姟烗痎絯仜灴疘紅倫錀婨綸",
          "鋙娪捂梧娙挳桱俓忍扨杒仞惡錏婭俹",
          "鋮鯎娍誠鰸嫗謳慪梀娕誎悚栍鉎鮏性",
          "键镑铻锷谤语谔诅齮齬齶齟徛徤徬徂",
          "閊問鍆們啚針什籵苖鈾伷粙芭岜吧粑",
          "間們閩菛傲螯蔜滶鑈蠒薾濔鍏暐偉湋",
          "隦檘礕僻喿碞偘煰蟥磺僙熿蜉郛桴烰",
          "颔鋡浛誝銍洷誈桎梵汎訉杋彬须釤杉",
          "颲颽楓偑覬梘俔靚皊柏伯皘冷冽凒凊",
          "餛飩餕餇忳悛恫憹痄痠痌癑炸焜炖燶",
          "駈拞茊蚯摎蓼蟉膠鲅茇蛂胈鲆駍抨胓",
          "駝鉈柁沱釨李汓吇旿杵汻吘蚎螞鉵虽",
          "駪駖騩傌聆聭佴耹雡魋倠雂謬詵詅訡",
          "駯銖鮢株鉍鮅柲泌煍鰍楸湫熛驃鏢漂",
          "騂駬溤榪聾瀧櫳巃鏳潧橧嶒釓乵耴乢",
          "驃螞駿駧痋痠痌疝耿焌烔灿聭魒螝嵬",
          "髏骲骹骯怉恔忼悗鰈鮫魧鮸鞢鞻鞄鞔",
          "髢髶髫鬀刵刟剃剈盱眧睇睊弙弛弭弲",
          "髰髭髹鬃鴜鵂鶎鷗鍭銝錝鏂喉呭呰嘔",
          "鬀鬙鬞髴熷燶炥炡瘏癑疿症署罤罾罡",
          "魏聭魈魒眲睄瞟瞍颹颵飃颼諱諉誀謏",
          "魯鰢鰉漁螞蝗浊虽茪皝洸咣苟昫駒呴",
          "鯢淣萖掜泣苙拉妾縚蓞搯嫍絃鮌泫妶",
          "鴚何呵砢伙吙炻炑挵哢硦梇挃鵄侄桎",
          "鴦怏岟柍怶岥柀詖揚崵楊諹措鵲惜諎",
          "鴨柙鉀押柛鉮捜訷媞鍉提諟姕鴜柴訿",
          "鴸鮢誅侏鮪詴侑栯屻訒仞杒峮鵘鮶桾",
          "鵏悑捕浦悼掉淖啅凎捦淦唫凋鵰惆啁",
          "鵼樢鷚鷯楓飂飉煈審寥寮灾羳羫样烊",
          "麾穈磨塺稡碎埣醉邝矿廛庮陪毰稖醅",
          "黒煮炰焦锗铇锥钞拼抱推抄鮩鯉鯺魦",
          "輩腓渄蜚腷湢蝠鶝禂淍蜩鵰祁陣阴鄥",]
        const defaultTimeout = 300

        var globalSolutions = []

        const group1 = "btn-success"
        const group2 = "btn-danger"
        const group3 = "btn-warning"
        const group4 = "btn-info"

        var unusedGroups = [group1, group2, group3, group4]
        function nextGroup() { return unusedGroups.pop() }

        function markSelected(e) { e.classList.add(isSelectedClass); e.classList.add("text-dark") }
        function markDeselected(e) { e.classList.remove(isSelectedClass); e.classList.remove("text-dark") }
        function isSelected(e) { return e.classList.contains(isSelectedClass) }
        function isSolved(e) {
            return e.classList.contains(group1) || e.classList.contains(group2) || e.classList.contains(group3) || e.classList.contains(group4)
        }
        function whichSelected() { return document.querySelectorAll(".".concat(isSelectedClass)) }
        function howManySelected() { return whichSelected().length }
        function whichUnsolved() { return document.querySelectorAll("#gameboard .defaultClass") }
        function howManyUnsolved() { return whichUnsolved().length }

        function guess() {
            var xs = whichSelected()
            var g = []
            for (var i = 0; i < xs.length; i++) {
                g.push(xs[i].textContent)
            }
            g.sort()
            return g
        }

        function orderNodes() {
            var i = 0
            for (child of document.querySelectorAll("#gameboard .cell")) {
                child.id = i
                i++
            }
        }

        function solveIfThreeQuartersSolved() {
            if (howManyUnsolved() != 4) {
                return
            }
            for (node of whichUnsolved()) {
                node.click()
            }
            sleep(1.2 * defaultTimeout).then(() => {
                document.getElementById("reloadRow").classList.remove("visually-hidden")
            })
        }

        function reorderOnSuccess() {
            ensureSemaphoreZero().then(() => {
                const next_group = nextGroup()
                const nodes = whichSelected()
                for (var i = nodes.length - 1; i >= 0; i--) {
                    for (node of whichSelected()) {
                        node.classList.add("animate__flipOutX")
                    }
                }
                sleep(defaultTimeout).then(() => {
                    for (node of whichSelected()) {
                        node.classList.remove("animate__flipOutX")
                        node.classList.remove(defaultButtonClass)
                        node.classList.add(next_group)
                        node.classList.add("animate__flipInX")
                        var surrCol = node.parentNode
                        surrCol.parentNode.prepend(surrCol)
                    }
                    sleep(0.5 * defaultTimeout).then(() => {
                        for (node of whichSelected()) {
                            node.classList.remove("animate__flipInX")
                            markDeselected(node)
                        }
                        orderNodes()
                        solveIfThreeQuartersSolved()
                    })
                })
            })
        }

        function shakeOnFailure() {
            for (node of whichSelected()) {
                node.classList.add("animate__headShake")
            }
            sleep(defaultTimeout).then(() => {
                for (node of whichSelected()) {
                    node.classList.remove("animate__headShake")
                    markDeselected(node)
                }
            })
        }

        function onClickCallback() {
            ensureSemaphoreZero().then(() => {
                e = document.getElementById(this.id)
                if (howManySelected() == 4 && !isSelected(e)) { return }
                if (isSolved(e)) { return }
                if (isSelected(e)) { markDeselected(e) } else { markSelected(e) }
                if (howManySelected() != 4) { return }
                const currGuess = guess()
                if (_.findIndex(globalSolutions, (o) => { return _.isEqual(o, currGuess) }) == -1) {
                    shakeOnFailure()
                    return
                }
                reorderOnSuccess()
                e.blur()
            });
        }

        // https://codeburst.io/throttling-and-debouncing-in-javascript-646d076d0a44
        function throttled(delay, fn) {
            let lastCall = 0;
            return function (...args) {
                const now = (new Date).getTime();
                if (now - lastCall < delay) { return; }
                lastCall = now;
                return fn(...args);
            }
        }

        function keylistener(e) {
            if (semaphore != 0) { return } // drop inputs during animation
            switch (e.code) {
                case "Digit1": document.getElementById("0").click(); break;
                case "Digit2": document.getElementById("1").click(); break;
                case "Digit3": document.getElementById("2").click(); break;
                case "Digit4": document.getElementById("3").click(); break;
                case "KeyQ": document.getElementById("4").click(); break;
                case "KeyW": document.getElementById("5").click(); break;
                case "KeyE": document.getElementById("6").click(); break;
                case "KeyR": document.getElementById("7").click(); break;
                case "KeyA": document.getElementById("8").click(); break;
                case "KeyS": document.getElementById("9").click(); break;
                case "KeyD": document.getElementById("10").click(); break;
                case "KeyF": document.getElementById("11").click(); break;
                case "KeyZ": document.getElementById("12").click(); break;
                case "KeyX": document.getElementById("13").click(); break;
                case "KeyC": document.getElementById("14").click(); break;
                case "KeyV": document.getElementById("15").click(); break;
                default: break;
            }
        }


        function main() {
            // Per animate.css, faster animations.
            document.documentElement.style.setProperty('--animate-duration', '.5s');

            var puzzle = _.sample(possiblePuzzles)
            var [solution1, solution2, solution3, solution4] = _.chunk(puzzle, 4)
            solution1.sort()
            solution2.sort()
            solution3.sort()
            solution4.sort()
            globalSolutions = [solution1, solution2, solution3, solution4]

            var puzzle_shuffled = _.shuffle(puzzle)

            orderNodes()
            for (var i = 0; i < 16; i++) {
                document.getElementById(i).innerHTML = puzzle_shuffled[i]
            }

            for (node of document.querySelectorAll("#gameboard .cell")) {
                node.onclick = onClickCallback
                node.classList.add(defaultButtonClass)
            }

            document.addEventListener('keypress', throttled(50, keylistener))
        }
        main()

    </script>

</body>

</html>
